name: "zeta-guard"

networks:
  zeta-guard:
    name: zeta-guard

services:
  keycloak-db:
    image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX:+$CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX/}postgres:17-alpine
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: zeta-guard
      POSTGRES_PASSWORD: geheim
    networks:
      - zeta-guard
    ports:
      - "15432:5432"
    healthcheck:
      test: pg_isready -h localhost -p 5432 -U zeta-guard -d keycloak
      interval: 3s
      timeout: 3s
      retries: 5

  keycloak:
    image: ${IMAGE_NAME:-zeta/zeta-guard/keycloak-zeta}:${IMAGE_TAG:-latest}
    environment:
      # Put Keycloak build options in the first build stage of the container image
      KC_DB: postgres
      KC_DB_URL: "jdbc:postgresql://keycloak-db:5432/keycloak"
      KC_DB_USERNAME: zeta-guard
      KC_DB_PASSWORD: geheim
      KC_BOOTSTRAP_ADMIN_USERNAME: zeta
      KC_BOOTSTRAP_ADMIN_PASSWORD: sigma
      KC_HEALTH_ENABLED: true
      KC_HOSTNAME: http://localhost:18080
      KC_HTTP_ENABLED: true
      # Initial hash for admin events log
      GENESIS_HASH: ${GENESIS_HASH:-4841c2142fef441daa6ee6c57db65c011935964b14e94a6c8f5ec0447b83526c}
    ports:
      - "18080:8080" # api port
      - "19000:9000" # mgmt
    networks:
      - zeta-guard
    healthcheck:
      # No curl in Keycloak ðŸ™„
      test: |
        exec 3<>/dev/tcp/127.0.0.1/9000; printf "GET /health/ready HTTP/1.1\r\nhost: localhost:9000\r\nConnection: close\r\n\r\n" >&3;grep "HTTP/1.1 200 OK" <&3
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      keycloak-db:
        condition: service_healthy
    command: start --log="console,file" --optimized

  keycloak-config-cli:
    image: ${IMAGE_KEYCLOAK_CONFIG:-zeta/zeta-guard/keycloak-config-cli}
    environment:
      KEYCLOAK_URL: "http://keycloak:8080"
      KEYCLOAK_USER: zeta
      KEYCLOAK_PASSWORD: sigma
      KEYCLOAK_AVAILABILITYCHECK_ENABLED: "true"
      KEYCLOAK_AVAILABILITYCHECK_TIMEOUT: 120s
      IMPORT_FILES: "/config/*"
      # See https://github.com/adorsys/keycloak-config-cli?tab=readme-ov-file#variable-substitution
      IMPORT_VARSUBSTITUTION_ENABLED: true
      KC_EVENT_LISTENER: zeta-guard-admin-events
      ADMIN_EVENT_LOGGING_ENABLED: true
      ADMIN_EVENT_LOGGING_DETAILS_ENABLED: true
    networks:
      - zeta-guard
    volumes:
      - ../realms:/config
      - ./scripts-it:/opt/keycloak/scripts
      - ./scripts-repository:/opt/keycloak/scripts-repository

